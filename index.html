<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Malaria vaccine impact tracker</title>
  <link rel="stylesheet" href="app.css">
</head>
<body>
  <div id="dataStatus" class="status-banner hidden" role="status" aria-live="polite"></div>

  <!-- Info tab (right edge, always visible) -->
  <button id="infoBtn" class="info-btn" aria-label="About the model">
    <svg width="14" height="14" viewBox="0 0 20 20" fill="none">
      <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="1.5"/>
      <path d="M10 9v5M10 6v1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
    Info
  </button>

  <!-- Info panel (slides in from right) -->
  <div id="infoPanel" class="info-panel">
    <div class="info-panel-header">
      <h2>About the model</h2>
      <button id="infoPanelClose" class="info-panel-close" aria-label="Close">&times;</button>
    </div>
    <div class="info-panel-content">
      <div class="about-section">
        <h3>How the model works</h3>
        <p>This tracker estimates how vaccine deliveries translate into doses administered, children fully vaccinated, and the downstream impact on malaria cases and deaths. It combines shipment timing, completion rates, and efficacy waning to model protection over time.</p>
        <p>All calculations are client-side and use the data files bundled with this site. You can explore assumptions in the sections below and switch scenarios using the controls on each view.</p>
      </div>
      <div class="about-section">
        <h3>Vaccine efficacy curves</h3>
        <p>The model accounts for waning vaccine efficacy over time. Efficacy data comes from clinical trials: <a href="https://pubmed.ncbi.nlm.nih.gov/?term=RTS%2CS+Clinical+Trials+Partnership+2015" target="_blank" rel="noopener noreferrer">RTS,S Clinical Trials Partnership (2015)</a> and <a href="https://pubmed.ncbi.nlm.nih.gov/?term=Datoo+2024+R21+malaria+vaccine" target="_blank" rel="noopener noreferrer">Datoo et al. (2024)</a>.</p>
        <div class="efficacy-chart-wrap">
          <canvas id="efficacyChart"></canvas>
        </div>
        <div class="efficacy-legend">
          <span class="legend-item"><span class="legend-color r21"></span> R21 (starts at 75%)</span>
          <span class="legend-item"><span class="legend-color rtss"></span> RTS,S (starts at 56%)</span>
        </div>
      </div>

      <div class="about-section">
        <h3>Model assumptions</h3>
        <ul class="assumptions-list">
          <li><strong>Doses per child:</strong> 4 (3 primary doses + 1 booster at 12 months)</li>
          <li><strong>Roll-out model:</strong> Linear ramp-up over 6 or 12 months (configurable)</li>
          <li><strong>Dose timing:</strong> Dose 2 at +1 month, dose 3 at +2 months, dose 4 at +14 months after dose 1</li>
          <li><strong>Efficacy curve:</strong> Flat at initial level until year 1, then linear decay through data points, then exponential extrapolation</li>
          <li><strong>3-dose efficacy:</strong> Same as 4-dose until year 1, then shifted: E₃(t) = E₄(t+1)</li>
          <li><strong>Dose reallocation:</strong> Cascade model where freed doses start new children with delayed timing</li>
          <li><strong>Age eligibility:</strong> 5–36 months follows WHO-recommended introduction ages (<a href="https://www.who.int/publications/i/item/who-wer9841-489-524" target="_blank" rel="noopener noreferrer">WHO position paper</a>); 6–60 months is an explicit sensitivity scenario using under-5 month-share fractions (54/60 and 31/60).</li>
        </ul>
      </div>


      <div class="about-section">
        <h3>Assumption provenance (sourced vs model choices)</h3>
        <ul class="assumptions-list">
          <li><strong>Sourced:</strong> Vaccine efficacy points and completion-rate scenario anchors come from cited studies/program reports in this panel.</li>
          <li><strong>Sourced:</strong> Country growth rates used for projection fallback are from <a href="https://data.worldbank.org/indicator/SP.POP.GROW" target="_blank" rel="noopener noreferrer">World Bank SP.POP.GROW</a> (2021-2023 averages).</li>
          <li><strong>Model choice (not externally sourced as a single number):</strong> 6- and 12-month linear roll-out options are scenario assumptions for planning and comparison.</li>
          <li><strong>Model choice:</strong> Default missing-growth fallback is 0.0% carry-forward from the 2023 baseline to avoid unsourced uplift where no country growth rate is available.</li>
          <li><strong>Model choice:</strong> Age-window fractions use month-share approximations (54/60 and 31/60 of under-5 population).</li>
        </ul>
      </div>

      <div class="about-section">
        <h3>Dose completion rates</h3>
        <p>Not all children who receive a first dose complete the full four-dose course. The model supports three scenarios based on real-world data:</p>
        <table class="completion-table">
          <thead>
            <tr><th>Scenario</th><th>Dose 2</th><th>Dose 3</th><th>Dose 4</th><th>Source</th></tr>
          </thead>
          <tbody>
            <tr><td>Optimistic</td><td>90%</td><td>88%</td><td>71%</td><td><a href="https://www.afro.who.int/countries/south-sudan/news/south-sudan-launches-second-phase-r21-malaria-vaccine-introduction-52-counties-protect-children" target="_blank" rel="noopener noreferrer">South Sudan R21 roll-out (WHO AFRO)</a></td></tr>
            <tr><td>Average</td><td>73%</td><td>61%</td><td>39%</td><td>Estimated mid-point</td></tr>
            <tr><td>Pessimistic</td><td>56%</td><td>34%</td><td>8%</td><td><a href="https://cdn.who.int/media/docs/default-source/immunization/mvip/full-evidence-report-on-the-rtss-as01-malaria-vaccine-for-sage-mpag-%28sept2021%29.pdf" target="_blank" rel="noopener noreferrer">Malawi RTS,S MVIP (WHO evidence report)</a></td></tr>
          </tbody>
        </table>
        <p><strong>Dose reallocation:</strong> When children drop out, their unused doses are reallocated to future children. This means more children can be fully vaccinated from the same number of doses than if no reallocation occurred.</p>

        <h4>Dose flow visualization</h4>
        <p class="sankey-intro">For every 100 children who start vaccination (<span id="sankeyScenario">Average</span> scenario):</p>
        <div class="sankey-diagram" id="sankeyDiagram">
          <canvas id="sankeyCanvas"></canvas>
        </div>
        <div class="sankey-legend" id="sankeyLegend"></div>
      </div>

      <div class="about-section">
        <h3>Vaccine pricing</h3>
        <table class="pricing-table">
          <thead>
            <tr><th>Vaccine</th><th>Price per dose</th><th>Cost per child (4 doses)</th></tr>
          </thead>
          <tbody>
            <tr><td>R21</td><td>$2.99</td><td>$11.96</td></tr>
            <tr><td>RTS,S</td><td>$9.81</td><td>$39.24</td></tr>
          </tbody>
        </table>
        <p class="source-note">Prices from Duncombe, Elabd and Sandefur (2024)</p>
      </div>

      <div class="about-section">
        <h3>Gavi co-financing</h3>
        <p>Countries contribute to vaccine costs based on their Gavi eligibility phase:</p>
        <table class="gavi-table">
          <thead>
            <tr><th>Phase</th><th>Co-financing</th></tr>
          </thead>
          <tbody>
            <tr><td>Initial self-financing</td><td>Flat $0.20 per dose</td></tr>
            <tr><td>Preparatory transition</td><td>$0.20/dose + 15% increase per year</td></tr>
            <tr><td>Accelerated transition</td><td>20% of dose price + 10 points per year</td></tr>
            <tr><td>Fully self-financing</td><td>100% of dose price</td></tr>
          </tbody>
        </table>
      </div>

      <div class="about-section">
        <h3>Data sources</h3>
        <ul class="sources-list">
          <li><strong>Shipment data:</strong> <a href="https://www.unicef.org/supply/documents/gavi-shipment-reports" target="_blank" rel="noopener noreferrer">UNICEF Supply Division shipment reports</a>, <a href="https://www.afro.who.int/health-topics/malaria" target="_blank" rel="noopener noreferrer">WHO AFRO malaria updates</a></li>
          <li><strong>Population data:</strong> <a href="https://population.un.org/wpp/" target="_blank" rel="noopener noreferrer">UN World Population Prospects (2024)</a> via <a href="https://ourworldindata.org/population-growth" target="_blank" rel="noopener noreferrer">Our World in Data</a></li>
          <li><strong>Malaria burden:</strong> <a href="https://www.who.int/teams/global-malaria-programme/reports/world-malaria-report-2024" target="_blank" rel="noopener noreferrer">WHO World Malaria Report (2024), Annex 4-F</a></li>
          <li><strong>Gavi eligibility:</strong> <a href="https://www.gavi.org/types-support/sustainability/eligibility" target="_blank" rel="noopener noreferrer">Gavi eligibility list</a></li>
          <li><strong>PMI funding:</strong> <a href="https://stacks.cdc.gov/view/cdc/154755" target="_blank" rel="noopener noreferrer">PMI Annual Report, April 2024</a></li>
          <li><strong>Efficacy data:</strong> <a href="https://pubmed.ncbi.nlm.nih.gov/?term=RTS%2CS+Clinical+Trials+Partnership+2015" target="_blank" rel="noopener noreferrer">RTS,S Clinical Trials Partnership (2015)</a>, <a href="https://pubmed.ncbi.nlm.nih.gov/?term=Datoo+2024+R21+malaria+vaccine" target="_blank" rel="noopener noreferrer">Datoo et al. (2024)</a></li>
        </ul>
        <div class="about-data-actions">
          <button id="downloadAllDataBtn" class="download-btn" type="button">Download all source data (JSON)</button>
          <span id="downloadAllDataStatus" class="share-link-status" aria-live="polite"></span>
        </div>
      </div>

      <div class="about-section">
        <h3>Understanding the numbers</h3>
        <p>This tracker shows two types of data:</p>
        <div class="provenance-legend">
          <div class="provenance-item">
            <span class="prov-badge prov-sourced">Sourced</span>
            <span>Data from official sources (shipments, population, malaria burden)</span>
          </div>
          <div class="provenance-item">
            <span class="prov-badge prov-estimated">Estimated</span>
            <span>Model outputs based on assumptions (cases averted, lives saved, doses administered)</span>
          </div>
        </div>
      </div>

      <div class="about-section">
        <h3>How projection year works (Needs view)</h3>
        <ul class="assumptions-list">
          <li><strong>Selector behavior:</strong> The Projection year dropdown selects the demographic basis year used for eligible-population and annual-maintenance calculations in the Needs view.</li>
          <li><strong>Year bounds:</strong> Years are clamped to the supported model window (currently 2025-2030).</li>
          <li><strong>Primary source:</strong> If a country has yearly demographic rows in the data table, the model uses the nearest available table year for that country.</li>
          <li><strong>Fallback source:</strong> If yearly rows are unavailable, the model compounds each country's annual growth rate from the 2023 baseline under-5 population and births (rates sourced from <a href="https://data.worldbank.org/indicator/SP.POP.GROW" target="_blank" rel="noopener noreferrer">World Bank SP.POP.GROW</a>, using 2021-2023 averages).</li>
          <li><strong>Default growth assumption:</strong> If a country-specific growth-rate input is missing, the model currently uses a 0.0%/year carry-forward fallback from the 2023 baseline (this is now a rare edge case).</li>
          <li><strong>Why 0.0% for now:</strong> Country rates are sourced from <a href="https://data.worldbank.org/indicator/SP.POP.GROW" target="_blank" rel="noopener noreferrer">World Bank annual population growth data (SP.POP.GROW)</a> averaged across 2021-2023. The neutral carry-forward default remains only as a fallback when a country rate is unavailable.</li>
          <li><strong>Transparency:</strong> The "Demographic basis" line in Needs reports whether the current estimate is table-based, growth-fallback, or mixed across countries.</li>
        </ul>
      </div>

      <div class="about-section">
        <h3>Limitations & caveats</h3>
        <ul class="assumptions-list">
          <li><strong>Administration timing:</strong> The model assumes linear roll-out of doses over 6-12 months. Actual timing varies by country and may be faster or slower.</li>
          <li><strong>Completion rates:</strong> Based on limited real-world data from early roll-outs. Rates may improve as programs mature.</li>
          <li><strong>Efficacy extrapolation:</strong> Long-term efficacy (beyond clinical trial follow-up) is extrapolated and uncertain.</li>
          <li><strong>Uniform efficacy:</strong> The model assumes vaccine efficacy is the same across all countries. Real-world efficacy may vary by malaria transmission intensity.</li>
          <li><strong>No seasonality:</strong> Malaria transmission seasonality is not modeled; incidence is treated as uniform throughout the year.</li>
          <li><strong>Data lag:</strong> Shipment data may be behind real-world deliveries. Some shipments may not be publicly reported.</li>
          <li><strong>Wastage:</strong> The model does not account for vaccine wastage.</li>
        </ul>
        <p class="caveat-note">These estimates are useful for understanding scale and progress, but should not be used for precise policy decisions without additional analysis.</p>
      </div>

      <div class="about-section">
        <h3>About this tool</h3>
        <p>This tracker was built by <strong>Ollie Sayeed</strong> using GPT-5 and Claude Code to make malaria vaccine progress transparent and accessible.</p>
        <p>The code is open source and available on <a href="https://github.com/OliSayeed/malaria-vaccine-tracker" target="_blank" rel="noopener noreferrer">GitHub</a>. Feedback, corrections, and contributions are welcome.</p>
        <p class="last-updated">Shipment data up to date with public information as of February 2026. Source: <a href="https://www.unicef.org/supply/documents/gavi-shipment-reports" target="_blank" rel="noopener noreferrer">UNICEF Gavi shipment reports</a>.</p>
      </div>
    </div>
  </div>
  <div id="infoPanelOverlay" class="info-panel-overlay"></div>

  <!-- Country picker panel -->
  <div id="countryPicker" class="country-picker" style="display:none">
    <div class="country-picker-header">
      <h3>Select countries to compare</h3>
      <button id="countryPickerClose" class="info-panel-close" aria-label="Close">&times;</button>
    </div>
    <div class="country-picker-actions">
      <button id="countryPickerAll" class="picker-btn">Select all</button>
      <button id="countryPickerNone" class="picker-btn">Clear all</button>
      <span id="countryPickerCount" class="picker-count">0 selected</span>
    </div>
    <div id="countryPickerList" class="country-picker-list">
      <!-- Populated by JS -->
    </div>
    <div class="country-picker-footer">
      <button id="countryPickerApply" class="picker-apply-btn">Apply selection</button>
    </div>
  </div>
  <div id="countryPickerOverlay" class="info-panel-overlay"></div>

  <!-- Top controls -->
  <div class="topbar">
    <!-- Row 1: Display, Country/Region, Mode -->
    <div class="row row-top">
      <div>
        <label class="lbl" for="view">Display</label><br>
        <select id="view">
          <option value="trackers" selected>Live trackers</option>
          <option value="trends">Trends</option>
          <option value="compare">Country rankings</option>
          <option value="map">Maps</option>
          <option value="countries">Country profiles</option>
          <option value="needs">Vaccination needs</option>
          <option value="shipments">Shipments</option>
        </select>
      </div>

      <div>
        <label class="lbl" for="country">Country/region</label><br>
        <select id="country">
          <option>Africa (total)</option>
        </select>
      </div>

      <div class="share-link-wrap">
        <span class="lbl control-label-spacer" aria-hidden="true">Share</span>
        <button id="copyShareLink" class="download-btn" type="button">Copy share link</button>
        <span id="copyShareStatus" class="share-link-status" aria-live="polite"></span>
      </div>
    </div>

    <!-- Row 2: Metric, Range, Vaccine (inserted by JS), Sort, Top N, Window label -->
    <div id="controlsRow" class="row row-sub" style="display:none">
      <!-- Metric -->
      <div>
        <span id="metricLbl" class="lbl">Metric</span><br>
        <select id="trendMetric">
          <option value="doses_delivered" selected>Doses delivered</option>
          <option value="doses">Doses administered (est.)</option>
          <option value="children">Children vaccinated (est.)</option>
          <option value="cases">Cases averted (est.)</option>
          <option value="lives">Lives saved (est.)</option>
          <option value="pmi_funding">PMI funding (USD)</option>
          <option value="malaria_cases">Malaria cases/year</option>
          <option value="malaria_deaths">Malaria deaths/year</option>
          <option value="coverage_pct">Coverage % (est.)</option>
          <option value="pop_at_risk">Population at risk</option>
          <option value="pop_under_5">Children under 5</option>
        </select>
        <button id="metricInfoBtn" class="info-tooltip-btn" data-tooltip="doses-delivered" aria-label="More info" style="display:none">
          <svg width="14" height="14" viewBox="0 0 20 20" fill="none">
            <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="1.5"/>
            <path d="M10 9v5M10 6v1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <!-- Range (dashboard trends only) -->
      <div>
        <span id="rangeLbl" class="lbl">Range</span><br>
        <select id="range">
          <option value="6">Last 6 months</option>
          <option value="12">Last 12 months</option>
          <option value="24" selected>Last 24 months</option>
          <option value="all">All available</option>
        </select>
      </div>

      <!-- Vaccine filter placeholder (JS replaces this with real control) -->
      <div id="vaccineControl"></div>

      <!-- Gavi filter (compare mode only) -->
      <div>
        <span id="gaviLbl" class="lbl">Gavi group</span><br>
        <select id="gaviFilter">
          <option value="all" selected>All countries</option>
          <option value="Initial self-financing">Initial self-financing</option>
          <option value="Preparatory transition">Preparatory transition</option>
          <option value="Accelerated transition">Accelerated transition</option>
          <option value="Fully self-financing">Fully self-financing</option>
        </select>
      </div>

      <!-- Model controls (for estimated metrics) -->
      <div id="modelControlsWrap" style="display:none">
        <span class="lbl">Course completion</span><br>
        <select id="chartCompletion">
          <option value="Average" selected>Average</option>
          <option value="Optimistic">Optimistic</option>
          <option value="Pessimistic">Pessimistic</option>
        </select>
      </div>
      <div id="rolloutControlWrap" style="display:none">
        <span class="lbl">Roll-out length</span><br>
        <select id="chartRollout">
          <option value="6" selected>6 mo</option>
          <option value="12">12 mo</option>
        </select>
      </div>

      <!-- Sort (compare mode only) -->
      <div>
        <span id="sortLbl" class="lbl">Sort</span><br>
        <select id="sort">
          <option value="desc" selected>Largest first</option>
          <option value="asc">Smallest first</option>
        </select>
      </div>

      <!-- Country picker (rankings mode) -->
      <div id="rankingPickerWrap" style="display:none">
        <span class="lbl">&nbsp;</span><br>
        <button id="rankingPickerBtn" class="download-btn">Select countries</button>
      </div>

      <!-- Compare countries button (trends mode only) -->
      <div id="compareCountriesWrap" style="display:none">
        <span class="lbl">&nbsp;</span><br>
        <button id="compareCountriesBtn" class="download-btn">Compare countries</button>
      </div>

      <!-- Availability window label for trends -->
      <span id="win" class="win"></span>
    </div>
  </div>

  <!-- Dashboard wrapper (trackers + trends) -->
  <main id="dashboard">
    <h1 class="title">Malaria vaccine impact tracker</h1>

    <!-- Live trackers -->
    <section id="trackers">
      <!-- Model controls for tracker -->
      <div class="tracker-controls">
        <div>
          <label class="lbl" for="trackerCompletion">Dose completion</label>
          <select id="trackerCompletion">
            <option value="Average" selected>Average</option>
            <option value="Optimistic">Optimistic</option>
            <option value="Pessimistic">Pessimistic</option>
          </select>
          <button class="info-tooltip-btn" data-tooltip="completion-rate" aria-label="More info">
            <svg width="14" height="14" viewBox="0 0 20 20" fill="none">
              <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="1.5"/>
              <path d="M10 9v5M10 6v1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div>
          <label class="lbl" for="rolloutPeriod">Roll-out period</label>
          <select id="rolloutPeriod">
            <option value="6" selected>6 months</option>
            <option value="12">12 months</option>
          </select>
          <button class="info-tooltip-btn" data-tooltip="rollout-period" aria-label="More info">
            <svg width="14" height="14" viewBox="0 0 20 20" fill="none">
              <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="1.5"/>
              <path d="M10 9v5M10 6v1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="metric">
        <div class="label">
          Total cases averted <span class="prov-badge prov-estimated">Estimated</span>
          <button class="info-tooltip-btn" data-tooltip="cases-averted" aria-label="More info">
            <svg width="14" height="14" viewBox="0 0 20 20" fill="none">
              <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="1.5"/>
              <path d="M10 9v5M10 6v1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div id="caseTotal" class="value">–</div>
        <div class="bar">
          <div id="caseBar" class="fill"></div>
        </div>
        <div id="caseTimer" class="timer">Loading…</div>
      </div>

      <div class="metric">
        <div class="label">
          Total lives saved <span class="prov-badge prov-estimated">Estimated</span>
          <button class="info-tooltip-btn" data-tooltip="lives-saved" aria-label="More info">
            <svg width="14" height="14" viewBox="0 0 20 20" fill="none">
              <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="1.5"/>
              <path d="M10 9v5M10 6v1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div id="lifeTotal" class="value">–</div>
        <div class="bar">
          <div id="lifeBar" class="fill"></div>
        </div>
        <div id="lifeTimer" class="timer">Loading…</div>
      </div>

      <!-- Shipments summary (populated by app.js; shown only in tracker view) -->
      <p id="ship"></p>
    </section>

    <!-- Trends view -->
    <section id="trends" style="display:none">
      <div id="trendCanvasWrap" class="trendCanvasWrap">
        <div id="yLabel" class="y-label">Doses delivered</div>
        <canvas id="trend"></canvas>
        <div id="trendTooltip" class="trendTooltip" style="display:none"></div>
        <div id="trendDot" class="trendDot"></div>
      </div>
      <div class="chart-actions">
        <button id="downloadTrend" class="download-btn" aria-label="Download chart">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
          </svg>
          Download chart
        </button>
        <button id="downloadTrendCsv" class="download-btn" aria-label="Download data (CSV)">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
          </svg>
          Download data (CSV)
        </button>
      </div>
      <div id="empty" class="empty" style="display:none">
        No data for selected range.
      </div>
    </section>

    <!-- Vaccination needs view -->
    <section id="needs" style="display:none">
      <div class="needs-controls">
        <div>
          <label class="lbl" for="ageGroup">Age window</label><br>
          <select id="ageGroup">
            <option value="6-60">6–60 months</option>
            <option value="5-36" selected>5–36 months</option>
          </select>
        </div>
        <div>
          <label class="lbl" for="needsVaccine">Vaccine price</label><br>
          <select id="needsVaccine">
            <option value="R21" selected>R21 ($2.99/dose)</option>
            <option value="RTS,S">RTS,S ($9.81/dose)</option>
          </select>
        </div>
        <div>
          <label class="lbl" for="completionScenario">Course completion</label><br>
          <select id="completionScenario">
            <option value="Average" selected>Average</option>
            <option value="Optimistic">Optimistic</option>
            <option value="Pessimistic">Pessimistic</option>
          </select>
        </div>
        <div>
          <label class="lbl" for="projectionYear">Projection year</label><br>
          <select id="projectionYear"></select>
        </div>
      </div>

      <p class="methodology-note">
        <strong>Methodology:</strong> Uses completion rates, dose reallocation, and projection-year demographics.
        <button class="info-tooltip-btn" data-tooltip="needs-methodology" aria-label="Needs methodology details">
          <svg width="14" height="14" viewBox="0 0 20 20" fill="none">
            <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="1.5"/>
            <path d="M10 9v5M10 6v1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </button>
        <br><span id="projectionMeta">Demographic basis: loading projection details…</span>
      </p>

      <div class="needs-grid">
        <!-- Coverage gap -->
        <div class="needs-card">
          <div class="needs-card-title">Coverage gap <span class="prov-badge prov-estimated">Estimated</span></div>
          <div class="needs-stat">
            <span class="needs-value" id="needsGap">–</span>
            <span class="needs-label">children not yet vaccinated</span>
          </div>
          <div class="needs-detail" id="needsCoverage">–</div>
        </div>

        <!-- Catch-up doses needed -->
        <div class="needs-card">
          <div class="needs-card-title">Catch-up doses needed <span class="prov-badge prov-estimated">Estimated</span></div>
          <div class="needs-stat">
            <span class="needs-value" id="needsDoses">–</span>
            <span class="needs-label">doses to close the gap</span>
          </div>
          <div class="needs-detail" id="needsDosesCost">–</div>
        </div>

        <!-- Annual flow -->
        <div class="needs-card">
          <div class="needs-card-title">Annual maintenance <span class="prov-badge prov-estimated">Estimated</span></div>
          <div class="needs-stat">
            <span class="needs-value" id="needsAnnual">–</span>
            <span class="needs-label">doses per year for new births</span>
          </div>
          <div class="needs-detail" id="needsAnnualCost">–</div>
        </div>

        <!-- Cost-effectiveness -->
        <div class="needs-card">
          <div class="needs-card-title">Cost-effectiveness <span class="prov-badge prov-estimated">Estimated</span></div>
          <div class="needs-stat">
            <span class="needs-value" id="needsCostPerLife">–</span>
            <span class="needs-label">per life saved (1-year estimate)</span>
          </div>
          <div class="needs-detail" id="needsCostPerCase">–</div>
        </div>
      </div>

      <div class="needs-compare-section">
        <div class="needs-compare-header">
          <h3>Compare selected countries</h3>
          <div class="needs-compare-actions">
            <button id="needsCompareBtn" class="picker-btn">Select countries</button>
            <span id="needsCompareCount" class="picker-count">0 selected</span>
            <button id="exportNeedsCompareCsv" class="download-btn">Export CSV</button>
            <button id="exportNeedsCompareXls" class="download-btn">Export Excel</button>
          </div>
        </div>
        <div class="table-wrap">
          <table class="needs-compare-table" id="needsCompareTable">
            <thead>
              <tr>
                <th>Country</th>
                <th class="num">Coverage gap</th>
                <th class="num">Coverage %</th>
                <th class="num">Catch-up doses</th>
                <th class="num">Annual doses</th>
                <th class="num">$/Life</th>
                <th class="num">$/Case</th>
              </tr>
            </thead>
            <tbody id="needsCompareBody">
              <tr><td colspan="7" style="text-align:center;color:#666">No countries selected</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Needs comparison chart -->
      <div class="needs-chart-section">
        <div class="needs-chart-controls">
          <div>
            <label class="lbl" for="needsChartMetric">Compare by</label><br>
            <select id="needsChartMetric">
              <option value="coverage_gap" selected>Coverage gap</option>
              <option value="cost_per_life">Cost per life saved</option>
              <option value="eligible">Eligible population</option>
              <option value="doses_needed">Doses needed</option>
            </select>
          </div>
          <div>
            <label class="lbl" for="needsChartTop">Show</label><br>
            <select id="needsChartTop">
              <option value="10" selected>Top 10</option>
              <option value="15">Top 15</option>
              <option value="all">All countries</option>
            </select>
          </div>
        </div>
        <div class="trendCanvasWrap">
          <canvas id="needsChart"></canvas>
          <div id="needsBarsTip" class="trendTooltip" style="display:none"></div>
        </div>
        <div class="chart-actions">
          <button id="downloadNeeds" class="download-btn" aria-label="Download chart">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
            </svg>
            Download chart
          </button>
          <button id="downloadNeedsCsv" class="download-btn" aria-label="Download data (CSV)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
            </svg>
            Download data (CSV)
          </button>
        </div>
      </div>
    </section>

    <!-- Countries comparison view -->
    <section id="countriesView" style="display:none">
      <div class="countries-controls">
        <div>
          <label class="lbl" for="countriesGavi">Gavi group</label><br>
          <select id="countriesGavi">
            <option value="all" selected>All countries</option>
            <option value="Initial self-financing">Initial self-financing</option>
            <option value="Preparatory transition">Preparatory transition</option>
            <option value="Accelerated transition">Accelerated transition</option>
            <option value="Fully self-financing">Fully self-financing</option>
          </select>
        </div>
        <div>
          <label class="lbl" for="countriesAgeGroup">Age window</label><br>
          <select id="countriesAgeGroup">
            <option value="6-60">6–60 months</option>
            <option value="5-36" selected>5–36 months</option>
          </select>
        </div>
        <div>
          <label class="lbl" for="countriesVaccine">Vaccine price</label><br>
          <select id="countriesVaccine">
            <option value="R21" selected>R21 ($2.99/dose)</option>
            <option value="RTS,S">RTS,S ($9.81/dose)</option>
          </select>
        </div>
        <div>
          <label class="lbl" for="countriesCompletion">Course completion</label><br>
          <select id="countriesCompletion">
            <option value="Average" selected>Average</option>
            <option value="Optimistic">Optimistic</option>
            <option value="Pessimistic">Pessimistic</option>
          </select>
        </div>
        <span class="sort-hint">Click column headers to sort</span>
      </div>
      <div class="countries-summary" id="countriesSummary"></div>
      <div class="table-actions">
        <button id="exportCountriesCsv" class="download-btn">Export CSV</button>
        <button id="exportCountriesXls" class="download-btn">Export Excel</button>
      </div>
      <div class="table-wrap">
        <table class="countries-table sortable-table" id="countriesTable">
          <thead>
            <tr>
              <th class="sortable" data-sort="name">Country</th>
              <th class="sortable" data-sort="gavi">Gavi</th>
              <th class="num sortable" data-sort="eligible-desc">Eligible <span class="prov-badge prov-sourced">Source</span></th>
              <th class="num sortable" data-sort="births-desc">Births/yr <span class="prov-badge prov-sourced">Source</span></th>
              <th class="num sortable" data-sort="vaccinated-desc">Protected <span class="prov-badge prov-estimated">Est.</span></th>
              <th class="num sortable" data-sort="coverage-desc">Coverage <span class="prov-badge prov-estimated">Est.</span>
                <button class="info-tooltip-btn" data-tooltip="coverage-pct" aria-label="More info">
                  <svg width="14" height="14" viewBox="0 0 20 20" fill="none">
                    <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M10 9v5M10 6v1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  </svg>
                </button>
              </th>
              <th class="num sortable" data-sort="cost-life-asc">$/Life
                <button class="info-tooltip-btn" data-tooltip="cost-life" aria-label="More info">
                  <svg width="14" height="14" viewBox="0 0 20 20" fill="none">
                    <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M10 9v5M10 6v1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  </svg>
                </button>
                <span class="prov-badge prov-estimated">Est.</span>
              </th>
              <th class="num sortable" data-sort="cost-case-asc">$/Case <span class="prov-badge prov-estimated">Est.</span></th>
              <th class="num sortable" data-sort="burden-desc">Deaths/yr <span class="prov-badge prov-sourced">Source</span></th>
            </tr>
          </thead>
          <tbody id="countriesBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Shipments table view -->
    <section id="shipments" style="display:none">
      <div class="shipments-controls">
        <div>
          <label class="lbl" for="shipmentStatus">Status</label><br>
          <select id="shipmentStatus">
            <option value="all" selected>All shipments</option>
            <option value="Delivered">Delivered only</option>
            <option value="Forecast">Forecast only</option>
            <option value="Purchased">Purchased only</option>
          </select>
        </div>
        <div>
          <label class="lbl" for="shipmentVaccine">Vaccine</label><br>
          <select id="shipmentVaccine">
            <option value="all" selected>Both vaccines</option>
            <option value="R21">R21 only</option>
            <option value="RTS,S">RTS,S only</option>
          </select>
        </div>
        <span class="sort-hint">Click column headers to sort</span>
      </div>
      <div class="shipments-summary" id="shipmentsSummary"></div>
      <div class="table-actions">
        <button id="exportShipmentsCsv" class="download-btn">Export CSV</button>
        <button id="exportShipmentsXls" class="download-btn">Export Excel</button>
      </div>
      <div class="table-wrap">
        <table class="shipments-table sortable-table" id="shipmentsTable">
          <thead>
            <tr>
              <th class="sortable" data-sort="date-desc">Date <span class="prov-badge prov-sourced">Source</span></th>
              <th class="sortable" data-sort="country">Country</th>
              <th>Vaccine</th>
              <th class="num sortable" data-sort="doses-desc">Doses <span class="prov-badge prov-sourced">Source</span></th>
              <th class="num">Children <span class="prov-badge prov-estimated">Est.</span></th>
              <th>Financing</th>
              <th>Status</th>
              <th>
                Efficacy
                <button class="info-tooltip-btn" data-tooltip="current-efficacy" aria-label="More info">
                  <svg width="14" height="14" viewBox="0 0 20 20" fill="none">
                    <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M10 9v5M10 6v1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  </svg>
                </button>
                <span class="prov-badge prov-estimated">Est.</span>
              </th>
            </tr>
          </thead>
          <tbody id="shipmentsBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Country rankings view -->
  <section id="compare" style="display:none">
    <div class="trendCanvasWrap">
      <canvas id="bars"></canvas>
      <div id="barsTip" class="trendTooltip" style="display:none"></div>
    </div>
    <div class="chart-actions">
      <button id="downloadCompare" class="download-btn" aria-label="Download chart">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
        </svg>
        Download chart
      </button>
      <button id="downloadCompareCsv" class="download-btn" aria-label="Download data (CSV)">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
        </svg>
        Download data (CSV)
      </button>
    </div>
  </section>

  <!-- Map view -->
  <section id="mapView" style="display:none">
    <div class="map-controls">
      <label class="lbl" for="mapMetric">Metric</label>
      <select id="mapMetric">
        <option value="gavi_group">Gavi financing group</option>
        <option value="coverage_pct">Coverage % (est.)</option>
        <option value="doses_delivered">Doses delivered</option>
        <option value="pop_at_risk">Population at risk</option>
        <option value="malaria_cases">Malaria cases/year</option>
        <option value="malaria_deaths">Malaria deaths/year</option>
      </select>
      <button class="info-tooltip-btn" data-tooltip="map-metric" aria-label="More info">
        <svg width="14" height="14" viewBox="0 0 20 20" fill="none">
          <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="1.5"/>
          <path d="M10 9v5M10 6v1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>
      <span id="mapAgeGroupWrap" style="display:none">
        <label class="lbl" for="mapAgeGroup">Age window</label>
        <select id="mapAgeGroup">
          <option value="6-60">6–60 months</option>
          <option value="5-36" selected>5–36 months</option>
        </select>
      </span>
      <span id="mapCompletionWrap" style="display:none">
        <label class="lbl" for="mapCompletion">Course completion</label>
        <select id="mapCompletion">
          <option value="Average" selected>Average</option>
          <option value="Optimistic">Optimistic</option>
          <option value="Pessimistic">Pessimistic</option>
        </select>
      </span>
    </div>
    <p class="methodology-note map-note">
      Click a country to see its vaccination trends. Hover for details. Grey countries have no malaria vaccine data.
      Data sources: WHO, UNICEF, Gavi. See <a href="#" class="open-about-link">About the model</a>.
    </p>
    <div class="map-container">
      <svg id="africaMap" viewBox="0 0 650 700" preserveAspectRatio="xMidYMid meet"></svg>
      <div id="mapTooltip" class="map-tooltip" style="display:none"></div>
    </div>
    <div id="mapLegend" class="map-legend"></div>
  </section>

  <!-- Tooltip popup (shown on click, populated by JS) -->
  <div id="tooltipPopup" class="tooltip-popup" style="display:none"></div>

  <!-- Tooltip templates (hidden, never displayed directly) -->
  <div id="tooltipTemplates" style="display:none">
      <div data-tooltip-id="current-efficacy">
        <strong>Current efficacy</strong>
        <p>Average vaccine efficacy across the cohort, accounting for the linear roll-out of doses and waning efficacy over time.</p>
        <p>Efficacy is flat at the initial level (75% for R21, 56% for RTS,S) until year 1, then decays according to clinical trial data.</p>
        <p>Children who complete only 3 doses (no booster) have faster-waning efficacy: their protection at time t equals 4-dose efficacy at time t+1.</p>
      </div>
      <div data-tooltip-id="completion-rate">
        <strong>Dose completion rates</strong>
        <p>Not all children who start vaccination complete all four doses. This setting adjusts the impact estimates based on real-world completion data.</p>
        <p><strong>Optimistic:</strong> 71% complete all four doses (<a href="https://www.afro.who.int/countries/south-sudan/news/south-sudan-launches-second-phase-r21-malaria-vaccine-introduction-52-counties-protect-children" target="_blank" rel="noopener noreferrer">South Sudan R21 roll-out</a>)<br>
        <strong>Average:</strong> 39% complete all four doses (estimated mid-point)<br>
        <strong>Pessimistic:</strong> 8% complete all four doses (<a href="https://cdn.who.int/media/docs/default-source/immunization/mvip/full-evidence-report-on-the-rtss-as01-malaria-vaccine-for-sage-mpag-%28sept2021%29.pdf" target="_blank" rel="noopener noreferrer">Malawi RTS,S MVIP</a>)</p>
        <p>The model accounts for dose reallocation: when children drop out, their unused doses are given to other children, creating cascading generations with delayed start times.</p>
      </div>
      <div data-tooltip-id="rollout-period">
        <strong>Roll-out period</strong>
        <p>The time it takes for a shipment of vaccines to be fully administered. First doses are spread linearly over this period.</p>
        <p><strong>6 months:</strong> Optimistic roll-out assumption<br>
        <strong>12 months:</strong> More conservative assumption</p>
        <p>Third doses occur 2 months after first doses, so protection starts building between month 2 and month 8 (for 6-month roll-out) or month 2 and month 14 (for 12-month roll-out).</p>
      </div>
      <div data-tooltip-id="coverage-pct">
        <strong>Coverage percentage</strong>
        <p>Percentage of eligible children in the selected age window who have completed the full 4-dose vaccination course.</p>
        <p>Default age window is 5–36 months (WHO recommendation). The 6–60 months option includes older children.</p>
        <p>This accounts for dose completion rates and reallocation: when children drop out, their unused doses are given to other children.</p>
      </div>
      <div data-tooltip-id="cost-life">
        <strong>Cost per life saved</strong>
        <p>Estimated cost to save one life through vaccination, calculated as: (cost per child) ÷ (deaths averted per child per year).</p>
        <p>Based on country-specific malaria mortality rates and vaccine efficacy at 1 year. Countries with higher malaria burden have lower cost per life saved.</p>
        <p>This is a theoretical estimate and actual cost-effectiveness may vary based on implementation factors.</p>
      </div>
      <div data-tooltip-id="cases-averted">
        <strong>Cases averted</strong>
        <p>Estimated malaria cases prevented by vaccination, calculated using:</p>
        <ul style="margin: 0.5rem 0; padding-left: 1.2rem;">
          <li>Number of fully vaccinated children (accounting for dose completion rates)</li>
          <li>Country-specific malaria incidence rate (cases per child per year)</li>
          <li>Time-weighted vaccine efficacy (accounting for waning over time)</li>
        </ul>
        <p><strong>Formula:</strong> children × incidence rate × average efficacy × time protected</p>
        <p>Dose reallocation is included: when children drop out, freed doses vaccinate additional children.</p>
      </div>
      <div data-tooltip-id="lives-saved">
        <strong>Lives saved</strong>
        <p>Estimated deaths prevented by vaccination. Calculated similarly to cases averted, but using the country-specific malaria mortality rate instead of incidence.</p>
        <p><strong>Key assumptions:</strong></p>
        <ul style="margin: 0.5rem 0; padding-left: 1.2rem;">
          <li>Vaccine efficacy against death equals efficacy against clinical malaria</li>
          <li>Mortality rate comes from WHO World Malaria Report 2024</li>
          <li>Protection wanes over time following clinical trial data</li>
        </ul>
        <p>The "time since last case/life" counter shows how the impact grows in real-time based on current vaccination coverage.</p>
      </div>
      <div data-tooltip-id="doses-delivered">
        <strong>Doses delivered</strong>
        <p>Total vaccine doses that have been shipped to countries. This is <strong>sourced data</strong> from UNICEF Supply Division and WHO.</p>
        <p><strong>Note:</strong> Delivered ≠ administered. There is typically a delay between delivery and administration, and some doses may be lost to wastage.</p>
      </div>
      <div data-tooltip-id="doses-administered">
        <strong>Doses administered</strong>
        <p>Estimated doses that have been given to children, based on the delivery date and roll-out period assumption.</p>
        <p>The model assumes doses are administered linearly over the roll-out period (6 or 12 months) after delivery.</p>
        <p>This is an <strong>estimate</strong> — actual administration data is not always publicly available in real-time.</p>
        <p><strong>Why it can look similar to "Doses delivered":</strong> once shipments are older than the selected roll-out period, estimated administered doses converge to delivered doses.</p>
      </div>
      <div data-tooltip-id="children-vaccinated">
        <strong>Children vaccinated</strong>
        <p>Estimated number of children who have completed the full 4-dose vaccination course.</p>
        <p><strong>Calculation:</strong> (doses administered ÷ 4) × dose-4 completion rate</p>
        <p>The completion rate varies by scenario (Optimistic: 71%, Average: 39%, Pessimistic: 8%). The model includes dose reallocation, where unused doses from dropouts vaccinate additional children.</p>
      </div>
      <div data-tooltip-id="needs-methodology">
        <strong>Needs methodology</strong>
        <p>Coverage gap = eligible children in the selected age window who have not completed all 4 doses.</p>
        <p><strong>Dose reallocation:</strong> unused doses from children who do not complete the full course are reassigned to other children over time.</p>
        <p><strong>Demographics:</strong> the selected projection year uses country-level yearly rows when available; otherwise country-specific growth rates from <a href="https://data.worldbank.org/indicator/SP.POP.GROW" target="_blank" rel="noopener noreferrer">World Bank SP.POP.GROW</a> (2021-2023 average) with a 0.0% carry-forward fallback when missing.</p>
      </div>

      <div data-tooltip-id="map-metric">
        <strong>Map metrics</strong>
        <p><strong>Gavi financing group:</strong> Countries' stage in Gavi's co-financing transition, determining how much they pay for vaccines.</p>
        <p><strong>Coverage %:</strong> Percentage of eligible children in the selected age window who have completed full vaccination. Use the Age window dropdown to switch between 5–36 and 6–60 months.</p>
        <p><strong>Other metrics:</strong> Population at risk, malaria cases, and deaths are sourced from WHO data.</p>
      </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-content">
      <p class="footer-attribution">
        Built by <strong>Ollie Sayeed</strong> using GPT-5 and Claude Code
      </p>
      <p class="footer-links">
        <a href="#" id="openAboutFooter">About the model</a>
        <span class="footer-sep">·</span>
        <a href="https://github.com/OliSayeed/malaria-vaccine-tracker" target="_blank" rel="noopener noreferrer">View on GitHub</a>
        <span class="footer-sep">·</span>
        <span class="footer-note">Shipment data current as of February 2026 · <a href="https://www.unicef.org/supply/documents/gavi-shipment-reports" target="_blank" rel="noopener noreferrer">UNICEF source</a></span>
      </p>
      <p class="footer-disclaimer">
        This tool provides estimates based on published data and modeling assumptions.
        All estimates should be interpreted with caution. See "About the model" for methodology and data sources.
      </p>
    </div>
  </footer>

  <script src="engine.js?v=20260210a"></script>
  <script src="app.js?v=20260210a" defer></script>
</body>
</html>
